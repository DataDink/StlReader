<html>
  <head>
    <script src="Stl.js"></script>
    <script src="Slice.js"></script>
    <style>
      div { border: 3px solid #FFF0F0; padding: 5px; display: inline-block; }
    </style>
  </head>
<body>
  <input type="file" />
  <script>
    var scale = 5;
    var input = document.querySelector('input[type=file]');
    input.addEventListener('change', i => {
      var file = i.target.files[0];

      var startStl = new Date().valueOf();
      Stl.fromFile(file).then(stl => {
        var endStl = new Date().valueOf();
        var startSlice = endStl;
        var slice = Slice.fromStl(stl, .2);
        var endSlice = new Date().valueOf();

        var left = 0; var right = 0; var tops = 0; var bottom = 0;
        var layers = Object.keys(slice.layers).map(l => parseFloat(l)).sort((a,b) => a-b);
        layers.forEach(l => slice.layers[l].forEach(r => r.forEach(v => {
          left = Math.floor(Math.min(left, v.x));
          right = Math.ceil(Math.max(right, v.x));
          tops = Math.floor(Math.min(tops, v.y));
          bottom = Math.ceil(Math.max(bottom, v.y));
        })));
        var width = Math.ceil((right - left) * scale);
        var height =  Math.ceil((bottom - tops) * scale);
        layers.forEach(layer => {
          var regions = slice.layers[layer];
          var container = document.createElement('div');
          var svg = document.createElement('svg');
          svg.setAttribute('width', width);
          svg.setAttribute('height', height);
          regions.forEach(region => {
            var polygon = document.createElement('polygon');
            var points = region.map(v =>
              ((v.x - left) * scale)
              + ','
              + ((v.y - tops) * scale)
            ).join(' ');
            polygon.setAttribute('points', points);
            polygon.style.fill = 'green';
            polygon.style.stroke = 'black';
            polygon.style.strokeWidth = '1';
            svg.appendChild(polygon);
          });
          container.appendChild(svg);
          container.innerHTML = container.innerHTML;
          document.body.appendChild(container);
        });
      });
    });
  </script>
</body>
</html>
